<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagos excursión (Firebase)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --victoria-green: #36ae6e;
      --victoria-green-dark: #2d8f5a;
      --victoria-yellow: #fdc73b;
      --victoria-blue: #2cbce9;
      --ink: #133022;
      --panel: #ffffff;
      --line: #d5e7de;
      --bg: #ecf7f1;
      --muted: #4b6a5a;
      font-family: "Montserrat", "Segoe UI", sans-serif;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 0% -10%, #d7f5e7 0%, transparent 60%),
        radial-gradient(900px 500px at 100% 0%, #fff2cf 0%, transparent 55%),
        var(--bg);
    }
    header {
      position:sticky;
      top:0;
      z-index:10;
      padding:10px 16px;
      border-bottom:1px solid #2a8a57;
      background:linear-gradient(120deg, var(--victoria-green-dark) 0%, var(--victoria-green) 52%, #34a868 100%);
      backdrop-filter: blur(4px);
    }
    .header-inner {
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }
    .brand img { height:32px; width:auto; }
    .brand-text b { display:block; font-size:14px; letter-spacing:.04em; }
    .brand-text span { display:block; font-size:11px; opacity:.92; }
    .price-badge {
      background:var(--victoria-yellow);
      color:var(--victoria-green-dark);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }
    main { padding:16px; max-width:980px; margin:0 auto; }
    .card {
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:20px;
      padding:16px;
      box-shadow:0 10px 30px rgba(35, 108, 74, .09);
      margin-bottom:14px;
    }
    .card-top {
      background:linear-gradient(140deg, #ffffff 0%, #f1fcf7 72%);
      border-color:#b9ddc8;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 auto; }
    input[type="text"], select {
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid #c7ddd1;
      background:#fff;
      color:var(--ink);
      font:600 14px "Montserrat", "Segoe UI", sans-serif;
    }
    input[type="text"]:focus, select:focus {
      outline:none;
      border-color:var(--victoria-green);
      box-shadow:0 0 0 3px rgba(54, 174, 110, .16);
    }
    .btn {
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:800;
      cursor:pointer;
      font-family:"Montserrat", "Segoe UI", sans-serif;
    }
    .btn.primary {
      background:var(--victoria-green-dark);
      color:#fff;
      box-shadow:0 8px 18px rgba(45, 143, 90, .25);
    }
    .btn.ghost {
      background:#e9f5ef;
      color:var(--victoria-green-dark);
      border:1px solid #c8e2d4;
    }
    .tabs {
      display:flex;
      gap:8px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      padding:6px 2px 11px 2px;
      border-bottom:1px solid #deece4;
      margin-bottom:12px;
    }
    .tab {
      flex:0 0 auto;
      white-space:nowrap;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #cde2d6;
      background:#fff;
      cursor:pointer;
      font-weight:800;
      color:#28513f;
    }
    .tab.active {
      background:linear-gradient(120deg, var(--victoria-green-dark), var(--victoria-green));
      color:#fff;
      border-color:#2f9b61;
    }
    table { width:100%; border-collapse:separate; border-spacing:0; }
    th, td { padding:11px 8px; border-bottom:1px solid #e6f2eb; text-align:left; vertical-align:middle; }
    th {
      font-size:11px;
      color:#39604f;
      text-transform:uppercase;
      letter-spacing:.05em;
      background:#f4fbf7;
    }
    .right { text-align:right; }
    .muted { color:var(--muted); font-size:13px; }
    .small { font-size:12px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .kpi > div {
      flex:1 1 140px;
      background:#f6fcf9;
      border:1px solid #d6ebe0;
      border-radius:14px;
      padding:10px;
    }
    .kpi b { font-size:20px; display:block; color:#224f3c; }
    .name-box {
      background:#f9fdfb;
      border:1px solid #dcede4;
      border-radius:12px;
      padding:10px;
      min-height:78px;
    }
    .checkbox { transform:scale(1.25); accent-color:var(--victoria-green); }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-weight:800; font-size:12px; }
    .pill.ok { background:#dff4e7; color:#245c41; }
    .pill.mid { background:#fff2cf; color:#7b6020; }
    .pill.no { background:#fee3e3; color:#7d3030; }
    .del {
      cursor:pointer;
      font-weight:800;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #e7c2c2;
      background:#fff3f3;
      color:#8b3a3a;
    }
    .hint, .err, .ok { padding:10px 12px; border-radius:12px; }
    .hint { background:#fff5d8; border:1px solid #f6d483; color:#5f4815; }
    .err { background:#ffe8e8; border:1px solid #f5bcbc; color:#792f2f; }
    .ok { background:#e3f8ec; border:1px solid #b6e4c9; color:#1c5f3d; }
    @media (max-width: 680px) {
      .brand img { height:28px; }
      .brand-text b { font-size:13px; }
      .price-badge { font-size:11px; padding:5px 8px; }
      th, td { padding:10px 6px; }
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <img src="https://victoriafp.com/images/logo/victoria-horizontal-color-rgb.svg" alt="Victoria FP" />
      <div class="brand-text">
        <b>Control de pagos</b>
        <span>Excursión por clase</span>
      </div>
    </div>
    <div class="price-badge">Total 25€</div>
  </div>
</header>
<main>

  <section class="card card-top">
    <div class="row" style="margin-top:10px;">
      <div>
        <b>Total:</b> 25€ <span class="muted">(11€ autobús + 14€ Entre ramas)</span><br>
        <span class="muted small">Datos compartidos en Firestore (tiempo real).</span>
      </div>
    </div>

    <div class="kpi">
      <div><span class="muted">Alumnos</span><b id="kpiAlumnos">—</b></div>
      <div><span class="muted">Pagados (25€)</span><b id="kpiPagados">—</b></div>
      <div><span class="muted">Recaudado</span><b id="kpiRecaudado">—</b></div>
      <div><span class="muted">Pendiente autobús</span><b id="kpiPendBus">—</b></div>
      <div><span class="muted">Pendiente entre ramas</span><b id="kpiPendEnt">—</b></div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="name-box">
        <b id="paidTitle">Han pagado todo (0)</b>
        <div id="paidList" class="muted small">—</div>
      </div>
      <div class="name-box">
        <b id="pendingTitle">Pendientes (0)</b>
        <div id="pendingList" class="muted small">—</div>
      </div>
    </div>

    <div id="statusBox" class="hint small" style="margin-top:12px; display:none;"></div>
  </section>

  <section class="card">
    <div style="margin-bottom:10px;">
      <label class="small muted">Clase / Módulo</label>
      <select id="classSelect"></select>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="row">
      <div><input id="search" type="text" placeholder="Buscar alumno..." /></div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div><input id="newName" type="text" placeholder="Añadir alumno a esta clase (opcional)..." /></div>
      <div class="right"><button class="btn primary" id="btnAdd" type="button">Añadir</button></div>
    </div>

    <div style="margin-top:10px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Alumno</th>
            <th class="right">Autobús<br><span class="muted small">11€</span></th>
            <th class="right">Entre ramas<br><span class="muted small">14€</span></th>
            <th class="right">Total</th>
            <th>Estado</th>
            <th class="right">Borrar</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">Cargando…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

<script type="module">
  const firebaseConfig = {
  "apiKey": "AIzaSyC2CYk-6D5IplkV48O-kme-eKDDG8oloAA",
  "authDomain": "convivencia-victoria.firebaseapp.com",
  "projectId": "convivencia-victoria",
  "storageBucket": "convivencia-victoria.firebasestorage.app",
  "messagingSenderId": "459565339869",
  "appId": "1:459565339869:web:988e7c6b8fe2db7f593734"
};

  const INITIAL = {
    classes: ["1º DAM","2º DAM","1º ASIR","1º Marketing","2º Marketing"],
    studentsByClass: {
      "1º DAM": [
  "Mario Hernández Ramos",
  "Sergio Jiménez Del Ojo",
  "Oscar Labarta González",
  "David Lázaro Vargas",
  "Carlos Mejías Campuzano",
  "Vicente Muñoz Polanco Quirós",
  "Guillermo Navascués Martínez",
  "Nuria Palacios Molinares",
  "María Pérez Jordán",
  "Hugo Ramírez Rodríguez",
  "Juan Yeray Vargas Gómez",
  "Juan Carlos Zamora Rodríguez",
  "Marcos Cabrera Pérez",
  "Gonzalo Castellano Ruiz",
  "Julia Delgado Iglesias",
  "Alejandro Domínguez Mora",
  "Alejandro Florido Caro",
  "Miguel Gómez Fernández",
  "Jaime González Ruiz",
  "Alejandro Guerrero Domínguez",
  "Román Gutiérrez Jurado"
],
      "2º DAM": [],
      "1º ASIR": [],
      "1º Marketing": [],
      "2º Marketing": []
    }
  };

  const PRICE_BUS = 11, PRICE_ENT = 14, PRICE_TOTAL = 25;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    getDocs, query, where, limit, onSnapshot, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const STUDENTS_COL = collection(db, "excursion_students");

  const $ = (id) => document.getElementById(id);
  const money = (n) => `${n}€`;

  let state = {
    clase: "1º DAM",
    search: "",
    students: []
  };

  function setStatus(text, kind="hint") {
    const el = $("statusBox");
    el.style.display = "block";
    el.className = (kind === "ok") ? "ok small" : (kind === "err" ? "err small" : "hint small");
    el.textContent = text;
  }

  function calcPaid(s) {
    const paid = (s.bus ? PRICE_BUS : 0) + (s.ent ? PRICE_ENT : 0);
    let status="Pendiente", cls="no";
    if (paid === 0) { status="Pendiente"; cls="no"; }
    else if (paid === PRICE_TOTAL) { status="Pagado"; cls="ok"; }
    else { status="Parcial"; cls="mid"; }
    return { paid, status, cls };
  }

  async function ensureSeeded() {
    const snap = await getDocs(query(STUDENTS_COL, limit(1)));
    if (!snap.empty) return;

    setStatus("Inicializando alumnos (primera vez)…", "hint");

    const batch = writeBatch(db);
    for (const cls of INITIAL.classes) {
      for (const name of (INITIAL.studentsByClass[cls] || [])) {
        const ref = doc(STUDENTS_COL);
        batch.set(ref, { name, class: cls, bus:false, ent:false, createdAt: Date.now() });
      }
    }
    await batch.commit();
  }

  function renderTabsAndSelect() {
    const sel = $("classSelect");
    sel.innerHTML = "";
    for (const cls of INITIAL.classes) {
      const opt = document.createElement("option");
      opt.value = cls; opt.textContent = cls;
      sel.appendChild(opt);
    }
    sel.value = state.clase;
    sel.onchange = () => { state.clase = sel.value; renderAll(); };

    const tabs = $("tabs");
    tabs.innerHTML = "";
    for (const cls of INITIAL.classes) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "tab" + (cls === state.clase ? " active" : "");
      btn.textContent = cls;
      btn.onclick = () => { state.clase = cls; sel.value = cls; renderAll(); };
      tabs.appendChild(btn);
    }
  }

  function renderKPI() {
    const classStudents = state.students.filter(s => s.class === state.clase);
    const totalStudents = classStudents.length;
    let recaudado = 0, pagados = 0, pendingBus = 0, pendingEnt = 0;
    const paidNames = [];
    const pendingNames = [];
    for (const s of classStudents) {
      const { paid } = calcPaid(s);
      recaudado += paid;
      if (paid === PRICE_TOTAL) {
        pagados++;
        paidNames.push(s.name);
      } else {
        pendingNames.push(s.name);
      }
      if (!s.bus) pendingBus += PRICE_BUS;
      if (!s.ent) pendingEnt += PRICE_ENT;
    }

    $("kpiAlumnos").textContent = totalStudents;
    $("kpiPagados").textContent = pagados;
    $("kpiRecaudado").textContent = money(recaudado);
    $("kpiPendBus").textContent = money(pendingBus);
    $("kpiPendEnt").textContent = money(pendingEnt);
    $("paidTitle").textContent = `Han pagado todo (${paidNames.length})`;
    $("pendingTitle").textContent = `Pendientes (${pendingNames.length})`;
    $("paidList").textContent = paidNames.length ? paidNames.join(", ") : "Ninguno";
    $("pendingList").textContent = pendingNames.length ? pendingNames.join(", ") : "Ninguno";
  }

  function renderTable() {
    const tbody = $("tbody");
    tbody.innerHTML = "";

    const term = (state.search || "").trim().toLowerCase();
    const list = state.students
      .filter(s => s.class === state.clase)
      .filter(s => !term || (s.name || "").toLowerCase().includes(term))
      .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"));

    if (list.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="6" class="muted">No hay alumnos (o no coincide la búsqueda).</td>';
      tbody.appendChild(tr);
      return;
    }

    for (const s of list) {
      const { paid, status, cls } = calcPaid(s);

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = s.name;

      const tdBus = document.createElement("td");
      tdBus.className = "right";
      const cbBus = document.createElement("input");
      cbBus.type = "checkbox";
      cbBus.className = "checkbox";
      cbBus.checked = !!s.bus;
      cbBus.onchange = async () => {
        try { await updateDoc(doc(STUDENTS_COL, s.id), { bus: cbBus.checked }); }
        catch { alert("No se pudo guardar. Revisa conexión/reglas."); cbBus.checked = !cbBus.checked; }
      };
      tdBus.appendChild(cbBus);

      const tdEnt = document.createElement("td");
      tdEnt.className = "right";
      const cbEnt = document.createElement("input");
      cbEnt.type = "checkbox";
      cbEnt.className = "checkbox";
      cbEnt.checked = !!s.ent;
      cbEnt.onchange = async () => {
        try { await updateDoc(doc(STUDENTS_COL, s.id), { ent: cbEnt.checked }); }
        catch { alert("No se pudo guardar. Revisa conexión/reglas."); cbEnt.checked = !cbEnt.checked; }
      };
      tdEnt.appendChild(cbEnt);

      const tdTotal = document.createElement("td");
      tdTotal.className = "right";
      tdTotal.textContent = money(paid);

      const tdStatus = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pill " + cls;
      pill.textContent = status;
      tdStatus.appendChild(pill);

      const tdDel = document.createElement("td");
      tdDel.className = "right";
      const delBtn = document.createElement("button");
      delBtn.className = "del";
      delBtn.type = "button";
      delBtn.textContent = "✕";
      delBtn.onclick = async () => {
        if (!confirm(`¿Borrar a "${s.name}" de ${s.class}?`)) return;
        try { await deleteDoc(doc(STUDENTS_COL, s.id)); }
        catch { alert("No se pudo borrar. Revisa conexión/reglas."); }
      };
      tdDel.appendChild(delBtn);

      tr.appendChild(tdName);
      tr.appendChild(tdBus);
      tr.appendChild(tdEnt);
      tr.appendChild(tdTotal);
      tr.appendChild(tdStatus);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    }
  }

  function renderAll() {
    renderTabsAndSelect();
    renderTable();
    renderKPI();
  }

  $("search").addEventListener("input", (e) => {
    state.search = e.target.value || "";
    renderTable();
  });

  $("btnAdd").onclick = async () => {
    const name = $("newName").value.trim();
    if (!name) return;
    try {
      await addDoc(STUDENTS_COL, { name, class: state.clase, bus:false, ent:false, createdAt: Date.now() });
      $("newName").value = "";
    } catch {
      alert("No se pudo añadir. Revisa conexión/reglas.");
    }
  };

  try {
    await signInAnonymously(auth);
  } catch (e) {
    console.error(e);
    setStatus("No se pudo autenticar (anónimo). Revisa Authentication en Firebase.", "err");
    throw e;
  }

  // Realtime
  onSnapshot(query(STUDENTS_COL), (snap) => {
    state.students = snap.docs.map(d => {
      const v = d.data();
      return { id:d.id, name:v.name||"", class:v.class||"", bus:!!v.bus, ent:!!v.ent };
    });
    renderAll();
  }, (err) => {
    console.error(err);
    setStatus("Error conectando a Firebase. Revisa reglas (test mode) y recarga.", "err");
  });

  // Seed
  try { await ensureSeeded(); }
  catch (e) { console.error(e); setStatus("No se pudo inicializar. Revisa reglas y recarga.", "err"); }

  renderAll();
</script>

</main>
</body>
</html>
