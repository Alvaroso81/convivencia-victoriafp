<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagos excursión (Firebase)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#f6f7f9; color:#111; }
    header { padding:14px 16px; background:#111; color:#fff; position:sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:16px; font-weight:900; }
    main { padding:14px 16px; max-width:980px; margin:0 auto; }
    .card { background:#fff; border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 auto; }
    input[type="text"], select {
      width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px; border:1px solid #d7dbe0; background:#fff;
    }
    .btn { border:0; border-radius:12px; padding:10px 12px; font-weight:900; cursor:pointer; }
    .btn.primary { background:#111; color:#fff; }
    .btn.ghost { background:#eef0f3; }
    .btn.danger { background:#ffebee; }
    .tabs {
      display:flex; gap:8px; overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      padding:6px 2px 10px 2px;
      border-bottom: 1px solid #eef0f3;
      margin-bottom: 10px;
    }
    .tab {
      flex: 0 0 auto; white-space:nowrap;
      padding:10px 12px; border-radius:999px;
      border:1px solid #d7dbe0; background:#fff;
      cursor:pointer; font-weight:900;
    }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid #eef0f3; text-align:left; vertical-align:middle; }
    th { font-size:12px; color:#444; text-transform:uppercase; letter-spacing:.04em; }
    .right { text-align:right; }
    .muted { color:#666; font-size:13px; }
    .small { font-size:12px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .kpi > div { flex:1 1 140px; background:#f3f5f8; border-radius:14px; padding:10px; }
    .kpi b { font-size:18px; display:block; }
    .checkbox { transform:scale(1.25); }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-weight:900; font-size:12px; }
    .pill.ok { background:#e8f5e9; }
    .pill.mid { background:#fff8e1; }
    .pill.no { background:#ffebee; }
    .del { cursor:pointer; font-weight:900; padding:6px 10px; border-radius:10px; border:1px solid #d7dbe0; background:#fff; }
    .hint { background:#fff8e1; border:1px solid #ffe0b2; padding:10px 12px; border-radius:12px; }
    .err { background:#ffebee; border:1px solid #ffcdd2; padding:10px 12px; border-radius:12px; }
    .ok { background:#e8f5e9; border:1px solid #c8e6c9; padding:10px 12px; border-radius:12px; }
  </style>
</head>
<body>
<header><h1>Control de pagos — Excursión (compartido)</h1></header>
<main>

  <section class="card">
    <div class="row" style="margin-top:10px;">
      <div>
        <b>Total:</b> 25€ <span class="muted">(11€ autobús + 14€ Entresramas)</span><br>
        <span class="muted small">Datos compartidos en Firestore (tiempo real).</span>
      </div>
    </div>

    <div class="kpi">
      <div><span class="muted">Alumnos</span><b id="kpiAlumnos">—</b></div>
      <div><span class="muted">Pagados (25€)</span><b id="kpiPagados">—</b></div>
      <div><span class="muted">Recaudado</span><b id="kpiRecaudado">—</b></div>
      <div><span class="muted">Pendiente</span><b id="kpiPendiente">—</b></div>
    </div>

    <div id="statusBox" class="hint small" style="margin-top:12px;">
      Conectando a Firebase…
    </div>
  </section>

  <section class="card">
    <div style="margin-bottom:10px;">
      <label class="small muted">Clase / Módulo</label>
      <select id="classSelect"></select>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="row">
      <div><input id="search" type="text" placeholder="Buscar alumno..." /></div>
      <div class="right"><button class="btn ghost" id="btnResetClass" type="button">Reset clase</button></div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div><input id="newName" type="text" placeholder="Añadir alumno a esta clase (opcional)..." /></div>
      <div class="right"><button class="btn primary" id="btnAdd" type="button">Añadir</button></div>
    </div>

    <div style="margin-top:10px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Alumno</th>
            <th class="right">Autobús<br><span class="muted small">11€</span></th>
            <th class="right">Entresramas<br><span class="muted small">14€</span></th>
            <th class="right">Total</th>
            <th>Estado</th>
            <th class="right">Borrar</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">Cargando…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

<script type="module">
  const firebaseConfig = {
  "apiKey": "AIzaSyC2CYk-6D5IplkV48O-kme-eKDDG8oloAA",
  "authDomain": "convivencia-victoria.firebaseapp.com",
  "projectId": "convivencia-victoria",
  "storageBucket": "convivencia-victoria.firebasestorage.app",
  "messagingSenderId": "459565339869",
  "appId": "1:459565339869:web:988e7c6b8fe2db7f593734"
};

  const INITIAL = {
    classes: ["1º DAM","2º DAM","1º ASIR","1º Marketing","2º Marketing"],
    studentsByClass: {
      "1º DAM": [
  "Mario Hernández Ramos",
  "Sergio Jiménez Del Ojo",
  "Oscar Labarta González",
  "David Lázaro Vargas",
  "Carlos Mejías Campuzano",
  "Vicente Muñoz Polanco Quirós",
  "Guillermo Navascués Martínez",
  "Nuria Palacios Molinares",
  "María Pérez Jordán",
  "Hugo Ramírez Rodríguez",
  "Juan Yeray Vargas Gómez",
  "Juan Carlos Zamora Rodríguez",
  "Marcos Cabrera Pérez",
  "Gonzalo Castellano Ruiz",
  "Julia Delgado Iglesias",
  "Alejandro Domínguez Mora",
  "Alejandro Florido Caro",
  "Miguel Gómez Fernández",
  "Jaime González Ruiz",
  "Alejandro Guerrero Domínguez",
  "Román Gutiérrez Jurado"
],
      "2º DAM": [],
      "1º ASIR": [],
      "1º Marketing": [],
      "2º Marketing": []
    }
  };

  const PRICE_BUS = 11, PRICE_ENT = 14, PRICE_TOTAL = 25;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    getDocs, query, where, limit, onSnapshot, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const STUDENTS_COL = collection(db, "excursion_students");

  const $ = (id) => document.getElementById(id);
  const money = (n) => `${n}€`;

  let state = {
    clase: "1º DAM",
    search: "",
    students: []
  };

  function setStatus(text, kind="hint") {
    const el = $("statusBox");
    el.className = (kind === "ok") ? "ok small" : (kind === "err" ? "err small" : "hint small");
    el.textContent = text;
  }

  function calcPaid(s) {
    const paid = (s.bus ? PRICE_BUS : 0) + (s.ent ? PRICE_ENT : 0);
    let status="Pendiente", cls="no";
    if (paid === 0) { status="Pendiente"; cls="no"; }
    else if (paid === PRICE_TOTAL) { status="Pagado"; cls="ok"; }
    else { status="Parcial"; cls="mid"; }
    return { paid, status, cls };
  }

  async function ensureSeeded() {
    const snap = await getDocs(query(STUDENTS_COL, limit(1)));
    if (!snap.empty) return;

    setStatus("Inicializando alumnos (primera vez)…", "hint");

    const batch = writeBatch(db);
    for (const cls of INITIAL.classes) {
      for (const name of (INITIAL.studentsByClass[cls] || [])) {
        const ref = doc(STUDENTS_COL);
        batch.set(ref, { name, class: cls, bus:false, ent:false, createdAt: Date.now() });
      }
    }
    await batch.commit();
  }

  function renderTabsAndSelect() {
    const sel = $("classSelect");
    sel.innerHTML = "";
    for (const cls of INITIAL.classes) {
      const opt = document.createElement("option");
      opt.value = cls; opt.textContent = cls;
      sel.appendChild(opt);
    }
    sel.value = state.clase;
    sel.onchange = () => { state.clase = sel.value; renderAll(); };

    const tabs = $("tabs");
    tabs.innerHTML = "";
    for (const cls of INITIAL.classes) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "tab" + (cls === state.clase ? " active" : "");
      btn.textContent = cls;
      btn.onclick = () => { state.clase = cls; sel.value = cls; renderAll(); };
      tabs.appendChild(btn);
    }
  }

  function renderKPI() {
    const totalStudents = state.students.length;
    let recaudado = 0, pagados = 0;
    for (const s of state.students) {
      const { paid } = calcPaid(s);
      recaudado += paid;
      if (paid === PRICE_TOTAL) pagados++;
    }
    const pendiente = totalStudents * PRICE_TOTAL - recaudado;

    $("kpiAlumnos").textContent = totalStudents;
    $("kpiPagados").textContent = pagados;
    $("kpiRecaudado").textContent = money(recaudado);
    $("kpiPendiente").textContent = money(pendiente);
  }

  function renderTable() {
    const tbody = $("tbody");
    tbody.innerHTML = "";

    const term = (state.search || "").trim().toLowerCase();
    const list = state.students
      .filter(s => s.class === state.clase)
      .filter(s => !term || (s.name || "").toLowerCase().includes(term))
      .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"));

    if (list.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="6" class="muted">No hay alumnos (o no coincide la búsqueda).</td>';
      tbody.appendChild(tr);
      return;
    }

    for (const s of list) {
      const { paid, status, cls } = calcPaid(s);

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = s.name;

      const tdBus = document.createElement("td");
      tdBus.className = "right";
      const cbBus = document.createElement("input");
      cbBus.type = "checkbox";
      cbBus.className = "checkbox";
      cbBus.checked = !!s.bus;
      cbBus.onchange = async () => {
        try { await updateDoc(doc(STUDENTS_COL, s.id), { bus: cbBus.checked }); }
        catch { alert("No se pudo guardar. Revisa conexión/reglas."); cbBus.checked = !cbBus.checked; }
      };
      tdBus.appendChild(cbBus);

      const tdEnt = document.createElement("td");
      tdEnt.className = "right";
      const cbEnt = document.createElement("input");
      cbEnt.type = "checkbox";
      cbEnt.className = "checkbox";
      cbEnt.checked = !!s.ent;
      cbEnt.onchange = async () => {
        try { await updateDoc(doc(STUDENTS_COL, s.id), { ent: cbEnt.checked }); }
        catch { alert("No se pudo guardar. Revisa conexión/reglas."); cbEnt.checked = !cbEnt.checked; }
      };
      tdEnt.appendChild(cbEnt);

      const tdTotal = document.createElement("td");
      tdTotal.className = "right";
      tdTotal.textContent = money(paid);

      const tdStatus = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pill " + cls;
      pill.textContent = status;
      tdStatus.appendChild(pill);

      const tdDel = document.createElement("td");
      tdDel.className = "right";
      const delBtn = document.createElement("button");
      delBtn.className = "del";
      delBtn.type = "button";
      delBtn.textContent = "✕";
      delBtn.onclick = async () => {
        if (!confirm(`¿Borrar a "${s.name}" de ${s.class}?`)) return;
        try { await deleteDoc(doc(STUDENTS_COL, s.id)); }
        catch { alert("No se pudo borrar. Revisa conexión/reglas."); }
      };
      tdDel.appendChild(delBtn);

      tr.appendChild(tdName);
      tr.appendChild(tdBus);
      tr.appendChild(tdEnt);
      tr.appendChild(tdTotal);
      tr.appendChild(tdStatus);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    }
  }

  function renderAll() {
    renderTabsAndSelect();
    renderTable();
    renderKPI();
  }

  $("search").addEventListener("input", (e) => {
    state.search = e.target.value || "";
    renderTable();
  });

  $("btnAdd").onclick = async () => {
    const name = $("newName").value.trim();
    if (!name) return;
    try {
      await addDoc(STUDENTS_COL, { name, class: state.clase, bus:false, ent:false, createdAt: Date.now() });
      $("newName").value = "";
    } catch {
      alert("No se pudo añadir. Revisa conexión/reglas.");
    }
  };

  $("btnResetClass").onclick = async () => {
    if (!confirm("¿Resetear pagos de la clase actual? (solo desmarca)")) return;
    try {
      const snap = await getDocs(query(STUDENTS_COL, where("class","==", state.clase)));
      const batch = writeBatch(db);
      snap.forEach(d => batch.update(d.ref, { bus:false, ent:false }));
      await batch.commit();
    } catch {
      alert("No se pudo resetear. Revisa conexión/reglas.");
    }
  };

  // Realtime
  onSnapshot(query(STUDENTS_COL), (snap) => {
    state.students = snap.docs.map(d => {
      const v = d.data();
      return { id:d.id, name:v.name||"", class:v.class||"", bus:!!v.bus, ent:!!v.ent };
    });
    renderAll();
    setStatus("Conectado. Cambios en tiempo real.", "ok");
  }, (err) => {
    console.error(err);
    setStatus("Error conectando a Firebase. Revisa reglas (test mode) y recarga.", "err");
  });

  // Seed
  try { await ensureSeeded(); }
  catch (e) { console.error(e); setStatus("No se pudo inicializar. Revisa reglas y recarga.", "err"); }

  renderAll();
</script>

</main>
</body>
</html>
