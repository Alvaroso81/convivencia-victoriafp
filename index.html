<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagos excursión (Firebase)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --victoria-green: #36ae6e;
      --victoria-green-dark: #2d8f5a;
      --victoria-yellow: #fdc73b;
      --victoria-blue: #2cbce9;
      --ink: #133022;
      --panel: #ffffff;
      --line: #d5e7de;
      --bg: #ecf7f1;
      --muted: #4b6a5a;
      font-family: "Montserrat", "Segoe UI", sans-serif;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 0% -10%, #d7f5e7 0%, transparent 60%),
        radial-gradient(900px 500px at 100% 0%, #fff2cf 0%, transparent 55%),
        var(--bg);
    }
    header {
      position:sticky;
      top:0;
      z-index:10;
      padding:10px 16px;
      border-bottom:1px solid #2a8a57;
      background:linear-gradient(120deg, var(--victoria-green-dark) 0%, var(--victoria-green) 52%, #34a868 100%);
      backdrop-filter: blur(4px);
    }
    .header-inner {
      max-width:980px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .header-logo {
      height:52px;
      width:auto;
    }
    .header-title {
      margin:0;
      color:#fff;
      text-align:center;
      font-size:19px;
      font-weight:800;
      letter-spacing:.02em;
    }
    main { padding:16px; max-width:980px; margin:0 auto; }
    .card {
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:20px;
      padding:16px;
      box-shadow:0 10px 30px rgba(35, 108, 74, .09);
      margin-bottom:14px;
    }
    .card-top {
      background:linear-gradient(140deg, #ffffff 0%, #f1fcf7 72%);
      border-color:#b9ddc8;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 auto; }
    input[type="text"], input[type="email"], input[type="password"], select {
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid #c7ddd1;
      background:#fff;
      color:var(--ink);
      font:600 14px "Montserrat", "Segoe UI", sans-serif;
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, select:focus {
      outline:none;
      border-color:var(--victoria-green);
      box-shadow:0 0 0 3px rgba(54, 174, 110, .16);
    }
    .btn {
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:800;
      cursor:pointer;
      font-family:"Montserrat", "Segoe UI", sans-serif;
    }
    .btn.primary {
      background:var(--victoria-green-dark);
      color:#fff;
      box-shadow:0 8px 18px rgba(45, 143, 90, .25);
    }
    .btn.ghost {
      background:#e9f5ef;
      color:var(--victoria-green-dark);
      border:1px solid #c8e2d4;
    }
    .tabs {
      display:flex;
      gap:8px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      padding:6px 2px 11px 2px;
      border-bottom:1px solid #deece4;
      margin-bottom:12px;
    }
    .tab {
      flex:0 0 auto;
      white-space:nowrap;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #cde2d6;
      background:#fff;
      cursor:pointer;
      font-weight:800;
      color:#28513f;
    }
    .tab.active {
      background:linear-gradient(120deg, var(--victoria-green-dark), var(--victoria-green));
      color:#fff;
      border-color:#2f9b61;
    }
    table { width:100%; border-collapse:separate; border-spacing:0; }
    th, td { padding:11px 8px; border-bottom:1px solid #e6f2eb; text-align:left; vertical-align:middle; }
    th {
      font-size:11px;
      color:#39604f;
      text-transform:uppercase;
      letter-spacing:.05em;
      background:#f4fbf7;
    }
    .right { text-align:right; }
    .muted { color:var(--muted); font-size:13px; }
    .small { font-size:12px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .kpi > div {
      flex:1 1 140px;
      background:#f7faf8;
      border:1px solid #dbe8e1;
      border-radius:14px;
      padding:10px;
    }
    .kpi b { font-size:20px; display:block; color:#224f3c; }
    .kpi-alumnos { background:#f2f7fb !important; border-color:#d8e6f3 !important; }
    .kpi-pagados { background:#f1fbf5 !important; border-color:#d2ecd9 !important; }
    .kpi-recaudado { background:#f3faf7 !important; border-color:#d7ebe2 !important; }
    .kpi-pend-bus { background:#fffaf1 !important; border-color:#f0e3c5 !important; }
    .kpi-pend-ent { background:#f8f4ff !important; border-color:#e3dbf4 !important; }
    .progress-card {
      background:#f9fdfb;
      border:1px solid #dcede4;
      border-radius:12px;
      padding:12px;
    }
    .progress-bar {
      height:10px;
      border-radius:999px;
      background:#ddecdf;
      overflow:hidden;
      margin-top:8px;
    }
    .progress-fill {
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--victoria-green-dark), var(--victoria-green), var(--victoria-blue));
      transition:width .25s ease;
    }
    .checkbox { transform:scale(1.25); accent-color:var(--victoria-green); }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-weight:800; font-size:12px; }
    .pill.ok { background:#dff4e7; color:#245c41; }
    .pill.mid { background:#fff2cf; color:#7b6020; }
    .pill.no { background:#fee3e3; color:#7d3030; }
    .del {
      cursor:pointer;
      font-weight:800;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #e7c2c2;
      background:#fff3f3;
      color:#8b3a3a;
    }
    .hint, .err, .ok { padding:10px 12px; border-radius:12px; }
    .hint { background:#fff5d8; border:1px solid #f6d483; color:#5f4815; }
    .err { background:#ffe8e8; border:1px solid #f5bcbc; color:#792f2f; }
    .ok { background:#e3f8ec; border:1px solid #b6e4c9; color:#1c5f3d; }
    .auth-box { margin-top:10px; }
    .summary-title {
      margin:12px 0 6px 0;
      font-size:13px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#1f5b3f;
      font-weight:800;
    }
    .btn[disabled], input[disabled] { opacity:.55; cursor:not-allowed; }
    @media (max-width: 680px) {
      .header-title { font-size:16px; }
      th, td { padding:10px 6px; }
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <img class="header-logo" src="logo.svg" alt="Logo Victoria FP" />
    <h1 class="header-title">Convivencia Victoria FP 4 marzo 2024</h1>
  </div>
</header>
<main>

  <section class="card card-top">
    <div class="row" style="margin-top:10px;">
      <div>
        <b>Total:</b> 25€ <span class="muted">(11€ autobús + 14€ Entre ramas)</span><br>
      </div>
    </div>

    <div class="auth-box">
      <div id="authMode" class="hint small" style="display:none;"></div>
      <div class="row" style="margin-top:8px;">
        <div><input id="editorEmail" type="email" placeholder="Email editor" /></div>
        <div><input id="editorPass" type="password" placeholder="Clave editor" /></div>
        <div class="right"><button class="btn ghost" id="btnLoginEditor" type="button">Entrar editor</button></div>
        <div class="right"><button class="btn ghost" id="btnLogoutEditor" type="button" style="display:none;">Salir editor</button></div>
      </div>
    </div>

    <div class="summary-title">Resumen global (todas las clases)</div>
    <div class="kpi">
      <div class="kpi-alumnos"><span class="muted">Alumnos</span><b id="gKpiAlumnos">—</b></div>
      <div class="kpi-pagados"><span class="muted">Pagados (25€)</span><b id="gKpiPagados">—</b></div>
      <div class="kpi-recaudado"><span class="muted">Recaudado</span><b id="gKpiRecaudado">—</b></div>
      <div class="kpi-pend-bus"><span class="muted">Pendiente autobús</span><b id="gKpiPendBus">—</b></div>
      <div class="kpi-pend-ent"><span class="muted">Pendiente entre ramas</span><b id="gKpiPendEnt">—</b></div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="progress-card">
        <b id="gPendingSummary">Pendientes: 0 de 0 (0%)</b>
        <div id="gPaidSummary" class="muted small">Pagado completo: 0 de 0 (0%)</div>
        <div class="progress-bar">
          <div id="gPaidProgressFill" class="progress-fill"></div>
        </div>
      </div>
    </div>

    <div class="summary-title">Resumen por clase (seleccionada)</div>
    <div class="kpi">
      <div class="kpi-alumnos"><span class="muted">Alumnos</span><b id="kpiAlumnos">—</b></div>
      <div class="kpi-pagados"><span class="muted">Pagados (25€)</span><b id="kpiPagados">—</b></div>
      <div class="kpi-recaudado"><span class="muted">Recaudado</span><b id="kpiRecaudado">—</b></div>
      <div class="kpi-pend-bus"><span class="muted">Pendiente autobús</span><b id="kpiPendBus">—</b></div>
      <div class="kpi-pend-ent"><span class="muted">Pendiente entre ramas</span><b id="kpiPendEnt">—</b></div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="progress-card">
        <b id="pendingSummary">Pendientes: 0 de 0 (0%)</b>
        <div id="paidSummary" class="muted small">Pagado completo: 0 de 0 (0%)</div>
        <div class="progress-bar">
          <div id="paidProgressFill" class="progress-fill"></div>
        </div>
      </div>
    </div>

    <div id="statusBox" class="hint small" style="margin-top:12px; display:none;"></div>
  </section>

  <section class="card">
    <div style="margin-bottom:10px;">
      <label class="small muted">Clase / Módulo</label>
      <select id="classSelect"></select>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="row">
      <div><input id="search" type="text" placeholder="Buscar alumno..." /></div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div><input id="newName" type="text" placeholder="Añadir alumno a esta clase (opcional)..." /></div>
      <div class="right"><button class="btn primary" id="btnAdd" type="button">Añadir</button></div>
    </div>

    <div style="margin-top:10px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Alumno</th>
            <th class="right">Autobús<br><span class="muted small">11€</span></th>
            <th class="right">Entre ramas<br><span class="muted small">14€</span></th>
            <th class="right">Total</th>
            <th>Estado</th>
            <th class="right">Borrar</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">Cargando…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

<script type="module">
  const firebaseConfig = {
  "apiKey": "AIzaSyC2CYk-6D5IplkV48O-kme-eKDDG8oloAA",
  "authDomain": "convivencia-victoria.firebaseapp.com",
  "projectId": "convivencia-victoria",
  "storageBucket": "convivencia-victoria.firebasestorage.app",
  "messagingSenderId": "459565339869",
  "appId": "1:459565339869:web:988e7c6b8fe2db7f593734"
};

  const INITIAL = {
    classes: ["1º DAM","2º DAM","1º ASIR","1º Marketing","2º Marketing","PROFESORES"],
    studentsByClass: {
      "1º DAM": [
  "Mario Hernández Ramos",
  "Sergio Jiménez Del Ojo",
  "Oscar Labarta González",
  "David Lázaro Vargas",
  "Carlos Mejías Campuzano",
  "Vicente Muñoz Polanco Quirós",
  "Guillermo Navascués Martínez",
  "Nuria Palacios Molinares",
  "María Pérez Jordán",
  "Hugo Ramírez Rodríguez",
  "Juan Yeray Vargas Gómez",
  "Juan Carlos Zamora Rodríguez",
  "Marcos Cabrera Pérez",
  "Gonzalo Castellano Ruiz",
  "Julia Delgado Iglesias",
  "Alejandro Domínguez Mora",
  "Alejandro Florido Caro",
  "Miguel Gómez Fernández",
  "Jaime González Ruiz",
  "Alejandro Guerrero Domínguez",
  "Román Gutiérrez Jurado"
],
      "2º DAM": [
  "Luis Blanco Montoro",
  "Rafael Blanco Valdés",
  "Rubén Carribero García",
  "Jesús Cervantes Fernández",
  "Jesús Damián Cintas Muñoz",
  "Antonio Jesús Domínguez López",
  "Ismael Flores Vargas",
  "José Luis Gómez Quevedo",
  "Antonio González Cruces",
  "Jaime González Montalbán",
  "Eloy López Ruiz",
  "Claudia Mellado Sánchez",
  "José Manuel Ortega Soto",
  "Gonzalo Polo Cocerría",
  "Antonio Nicolás Prast Becerra",
  "Joaquín Rivera Tirado",
  "David Rodríguez González",
  "David Sánchez Acosta",
  "Koldo Uruburu Elizalde",
  "Francisco Valencia Márquez",
  "Alejandro Vallín Bejarano",
  "Rubén Vega Ramírez",
  "Félix Venegas Roldán",
  "Francisco de Nazaret Virlan Rodríguez"
],
      "1º ASIR": [
  "Alejandro Benítez Carballo",
  "Rubén Salguero Domínguez",
  "Miguel Ángel Ramírez López",
  "Airon Navarro Delgado",
  "Alejandro López Ramírez"
],
      "1º Marketing": [
  "José Manuel Pérez Alfonseca",
  "José Antonio Palma Orihuela",
  "Jonathan Otero Vidal",
  "Jorge Sáenz Silva",
  "Carla Antón Morales"
],
      "2º Marketing": [
  "Marta Franco",
  "Candela Ibáñez",
  "Cristhian Rodríguez",
  "Carmen Galán",
  "Rodrigo Aguilar"
],
      "PROFESORES": [
  "Alvaro Osorio",
  "David Soto",
  "Alonso Guillen",
  "Guido Sansalone",
  "Tatiana Moreno",
  "Carmen Garcia",
  "Victoria Rodriguez"
]
    }
  };

  const PRICE_BUS = 11, PRICE_ENT = 14, PRICE_TOTAL = 25;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    getDocs, query, onSnapshot, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const STUDENTS_COL = collection(db, "excursion_students");
  const ALLOWED_EDITOR_UIDS = new Set([
    "7CAf1CxCw3OEchwhzQjAQupe45D2",
    "DFV2CdIYCGcDV2pInlAhBKwv5k22"
  ]);

  const $ = (id) => document.getElementById(id);
  const money = (n) => `${n}€`;

  let state = {
    clase: "1º DAM",
    search: "",
    students: [],
    isEditor: false,
    userEmail: ""
  };

  function setStatus(text, kind="hint") {
    const el = $("statusBox");
    el.style.display = "block";
    el.className = (kind === "ok") ? "ok small" : (kind === "err" ? "err small" : "hint small");
    el.textContent = text;
  }

  function calcPaid(s) {
    const paid = (s.bus ? PRICE_BUS : 0) + (s.ent ? PRICE_ENT : 0);
    let status="Pendiente", cls="no";
    if (paid === 0) { status="Pendiente"; cls="no"; }
    else if (paid === PRICE_TOTAL) { status="Pagado"; cls="ok"; }
    else { status="Parcial"; cls="mid"; }
    return { paid, status, cls };
  }

  async function ensureRosterSynced() {
    if (!state.isEditor) return;
    const snap = await getDocs(STUDENTS_COL);
    // Seed only once when the collection is empty.
    // If a student is intentionally deleted, do not recreate it later.
    if (!snap.empty) return;
    const batch = writeBatch(db);
    for (const cls of INITIAL.classes) {
      for (const name of (INITIAL.studentsByClass[cls] || [])) {
        const ref = doc(STUDENTS_COL);
        batch.set(ref, { name, class: cls, bus:false, ent:false, createdAt: Date.now() });
      }
    }
    await batch.commit();
  }

  function renderTabsAndSelect() {
    const sel = $("classSelect");
    sel.innerHTML = "";
    for (const cls of INITIAL.classes) {
      const opt = document.createElement("option");
      opt.value = cls; opt.textContent = cls;
      sel.appendChild(opt);
    }
    sel.value = state.clase;
    sel.onchange = () => { state.clase = sel.value; renderAll(); };

    const tabs = $("tabs");
    tabs.innerHTML = "";
    for (const cls of INITIAL.classes) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "tab" + (cls === state.clase ? " active" : "");
      btn.textContent = cls;
      btn.onclick = () => { state.clase = cls; sel.value = cls; renderAll(); };
      tabs.appendChild(btn);
    }
  }

  function calcMetrics(students) {
    const totalStudents = students.length;
    let recaudado = 0, pagados = 0, pendingBus = 0, pendingEnt = 0;
    for (const s of students) {
      const { paid } = calcPaid(s);
      recaudado += paid;
      if (paid === PRICE_TOTAL) pagados++;
      if (!s.bus) pendingBus += PRICE_BUS;
      if (!s.ent) pendingEnt += PRICE_ENT;
    }
    const pendingCount = totalStudents - pagados;
    const paidPct = totalStudents ? Math.round((pagados / totalStudents) * 100) : 0;
    const pendingPct = totalStudents ? Math.round((pendingCount / totalStudents) * 100) : 0;
    return { totalStudents, recaudado, pagados, pendingBus, pendingEnt, pendingCount, paidPct, pendingPct };
  }

  function renderKPI() {
    const global = calcMetrics(state.students);
    const classStudents = state.students.filter(s => s.class === state.clase);
    const byClass = calcMetrics(classStudents);

    $("gKpiAlumnos").textContent = global.totalStudents;
    $("gKpiPagados").textContent = global.pagados;
    $("gKpiRecaudado").textContent = money(global.recaudado);
    $("gKpiPendBus").textContent = money(global.pendingBus);
    $("gKpiPendEnt").textContent = money(global.pendingEnt);
    $("gPendingSummary").textContent = `Pendientes: ${global.pendingCount} de ${global.totalStudents} (${global.pendingPct}%)`;
    $("gPaidSummary").textContent = `Pagado completo: ${global.pagados} de ${global.totalStudents} (${global.paidPct}%)`;
    $("gPaidProgressFill").style.width = `${global.paidPct}%`;

    $("kpiAlumnos").textContent = byClass.totalStudents;
    $("kpiPagados").textContent = byClass.pagados;
    $("kpiRecaudado").textContent = money(byClass.recaudado);
    $("kpiPendBus").textContent = money(byClass.pendingBus);
    $("kpiPendEnt").textContent = money(byClass.pendingEnt);
    $("pendingSummary").textContent = `Pendientes: ${byClass.pendingCount} de ${byClass.totalStudents} (${byClass.pendingPct}%)`;
    $("paidSummary").textContent = `Pagado completo: ${byClass.pagados} de ${byClass.totalStudents} (${byClass.paidPct}%)`;
    $("paidProgressFill").style.width = `${byClass.paidPct}%`;
  }

  function renderEditorUI() {
    const canEdit = state.isEditor;
    $("newName").disabled = !canEdit;
    $("btnAdd").disabled = !canEdit;

    $("editorEmail").disabled = canEdit;
    $("editorPass").disabled = canEdit;
    $("btnLoginEditor").style.display = canEdit ? "none" : "inline-block";
    $("btnLogoutEditor").style.display = canEdit ? "inline-block" : "none";

    const authMode = $("authMode");
    if (canEdit) {
      authMode.style.display = "block";
      authMode.className = "ok small";
      authMode.textContent = `Modo editor activo: ${state.userEmail}`;
    } else {
      authMode.style.display = "none";
    }
  }

  function renderTable() {
    const tbody = $("tbody");
    tbody.innerHTML = "";

    const term = (state.search || "").trim().toLowerCase();
    const list = state.students
      .filter(s => s.class === state.clase)
      .filter(s => !term || (s.name || "").toLowerCase().includes(term))
      .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"));

    if (list.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="6" class="muted">No hay alumnos (o no coincide la búsqueda).</td>';
      tbody.appendChild(tr);
      return;
    }

    for (const s of list) {
      const { paid, status, cls } = calcPaid(s);

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = s.name;

      const tdBus = document.createElement("td");
      tdBus.className = "right";
      const cbBus = document.createElement("input");
      cbBus.type = "checkbox";
      cbBus.className = "checkbox";
      cbBus.checked = !!s.bus;
      cbBus.disabled = !state.isEditor;
      cbBus.onchange = async () => {
        try { await updateDoc(doc(STUDENTS_COL, s.id), { bus: cbBus.checked }); }
        catch { alert("No se pudo guardar. Revisa conexión/reglas."); cbBus.checked = !cbBus.checked; }
      };
      tdBus.appendChild(cbBus);

      const tdEnt = document.createElement("td");
      tdEnt.className = "right";
      const cbEnt = document.createElement("input");
      cbEnt.type = "checkbox";
      cbEnt.className = "checkbox";
      cbEnt.checked = !!s.ent;
      cbEnt.disabled = !state.isEditor;
      cbEnt.onchange = async () => {
        try { await updateDoc(doc(STUDENTS_COL, s.id), { ent: cbEnt.checked }); }
        catch { alert("No se pudo guardar. Revisa conexión/reglas."); cbEnt.checked = !cbEnt.checked; }
      };
      tdEnt.appendChild(cbEnt);

      const tdTotal = document.createElement("td");
      tdTotal.className = "right";
      tdTotal.textContent = money(paid);

      const tdStatus = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pill " + cls;
      pill.textContent = status;
      tdStatus.appendChild(pill);

      const tdDel = document.createElement("td");
      tdDel.className = "right";
      const delBtn = document.createElement("button");
      delBtn.className = "del";
      delBtn.type = "button";
      delBtn.textContent = "✕";
      delBtn.disabled = !state.isEditor;
      delBtn.onclick = async () => {
        if (!state.isEditor) return;
        if (!confirm(`¿Borrar a "${s.name}" de ${s.class}?`)) return;
        try { await deleteDoc(doc(STUDENTS_COL, s.id)); }
        catch { alert("No se pudo borrar. Revisa conexión/reglas."); }
      };
      tdDel.appendChild(delBtn);

      tr.appendChild(tdName);
      tr.appendChild(tdBus);
      tr.appendChild(tdEnt);
      tr.appendChild(tdTotal);
      tr.appendChild(tdStatus);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    }
  }

  function renderAll() {
    renderEditorUI();
    renderTabsAndSelect();
    renderTable();
    renderKPI();
  }

  $("search").addEventListener("input", (e) => {
    state.search = e.target.value || "";
    renderTable();
  });

  $("btnAdd").onclick = async () => {
    if (!state.isEditor) {
      alert("Solo los editores pueden modificar datos.");
      return;
    }
    const name = $("newName").value.trim();
    if (!name) return;
    try {
      await addDoc(STUDENTS_COL, { name, class: state.clase, bus:false, ent:false, createdAt: Date.now() });
      $("newName").value = "";
    } catch {
      alert("No se pudo añadir. Revisa conexión/reglas.");
    }
  };

  $("btnLoginEditor").onclick = async () => {
    const email = $("editorEmail").value.trim().toLowerCase();
    const pass = $("editorPass").value;
    if (!email || !pass) {
      alert("Introduce email y clave.");
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      $("editorPass").value = "";
    } catch (e) {
      console.error(e);
      alert("No se pudo iniciar sesion como editor.");
    }
  };

  $("btnLogoutEditor").onclick = async () => {
    try {
      await signOut(auth);
    } catch (e) {
      console.error(e);
      alert("No se pudo cerrar sesion.");
    }
  };

  onAuthStateChanged(auth, async (user) => {
    const email = (user?.email || "").toLowerCase();
    const uid = user?.uid || "";
    state.userEmail = email;
    state.isEditor = !!user && ALLOWED_EDITOR_UIDS.has(uid);

    if (user && !state.isEditor) {
      await signOut(auth);
      state.userEmail = "";
      state.isEditor = false;
    }

    try { await ensureRosterSynced(); }
    catch (e) { console.error(e); setStatus("No se pudo inicializar. Revisa reglas y recarga.", "err"); }

    renderAll();
  });

  // Realtime
  onSnapshot(query(STUDENTS_COL), (snap) => {
    state.students = snap.docs.map(d => {
      const v = d.data();
      return { id:d.id, name:v.name||"", class:v.class||"", bus:!!v.bus, ent:!!v.ent };
    });
    renderAll();
  }, (err) => {
    console.error(err);
    setStatus("Error conectando a Firebase. Revisa reglas (test mode) y recarga.", "err");
  });

  renderAll();
</script>

</main>
</body>
</html>
